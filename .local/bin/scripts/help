#!/bin/sh
# open info-page, man-page or command help
# depends: unbuffer
# optdepends: highlight(dotfiles)
paginate="${PAGER:-less} +Gg"
test "$1" = "-d" && browse=1 && shift
cmd="$1"
case "$cmd" in
	(zsh|zmv) # https://unix.stackexchange.com/questions/19290/zmv-for-zsh-dry-runs-and-man-pages
		for last; do true; done
		# need to install zsh-doc package for info pages
		info $(test "$last" != zsh && echo "--index-search=$last") zsh ||
			LESS="$LESS +/^ *$last *\\[" man zshall;;
	(gh|chordpro|bat|pdfjam|reflector|topgrade|r128gain|7z|kubectl|diffr|docker) unbuffer "$@" --help | $paginate;;
	(caddy|stretchly|go|fossil) test "$cmd" = "fossil" -a $# -eq 1 && repo="$(locate -b -l 1 "fossil*.fossil")" && fossil ui "$repo" && exit
		# TODO view fossil ui in terminal
		shift
		"$cmd" help "$@" | $paginate;;
	(rails) { rails -H && rails --help; } | $paginate;;
	(plantuml) unbuffer "$@" -help | $paginate;;
	(vlc) shift && unbuffer vlc --full-help "$@" | $paginate;;
	(kdeconnect*) shift && kdeconnect-cli --help-all "$@" | $paginate;;
	(pandoc) man pandoc; highlight "Extensions" && pandoc --list-extensions | paste -s -d' ';;
	(swaymsg) test $# -gt 1 && shift && man sway "$@" || man swaymsg;;
	(swaymsg-*) man sway "${1#swaymsg-}";;
	(*) {
		which info >/dev/null 2>&1 &&
			case $EDITOR in
				(*vim) info "$@" -w | grep -q . && $EDITOR -R -M -c "Info $*" +only;;
				(*) info -f "$@" 2>/dev/null;;
			esac ||
				man "$@"
		} ||
		if which "$cmd" >/dev/null
		then { "$@" --help || { test $? == 1 && "$@" -help; } || { test $? == 1 && "$@" -h; }; } 2>&1 | $paginate
		fi;;
esac
docs="/usr/share/doc/$cmd"
if test -d "$docs"; then
	if test -z "$browse"
	then echo "Find more in $docs"
	else
		len() { echo "$1" | wc -c; }
		shortest() {
			read shortest
			while read in
			do test $(len $shortest) -gt $(len $in) && shortest=$in
			done
			echo $shortest
		}
		firefox "file://$(find $docs -name index.html | shortest | grep . || find $docs -name $1*.html | shortest)"
	fi
fi
