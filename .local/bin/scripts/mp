#!/bin/sh
# Play given files on mpd, enabling playing of external files through symlinking and recursively resolving playlists
# depends: xargs mpc realpath
# env: MUSIC
PLAYLISTS="$MUSIC/Playlists"
LINKS="$MUSIC/links"
if test "$1" = "-r"
then shift
  test "$1" = "-v" && verbose=-v && shift
  for arg;
  do path="$(test -e "$arg" && realpath "$arg" ||
      ( test -e "$MUSIC/$arg" && realpath "$MUSIC/$arg") ||
      ( test -e "$PLAYLISTS/$arg" && realpath "$PLAYLISTS/$arg") )"
    test -n "$verbose" && echo "Scanning path '$path' from '$arg'" >&2
    test -n "$path" || continue
    if file "$path" | grep -i ' playlist' || expr "$path" : ".*\.m3u8\?$" >/dev/null
    then pushd "$(dirname "$path")" >/dev/null && cat "$path" | xargs --delim='\n' "$0" $verbose -r && popd >/dev/null
    else
      find "$path" -name "*.flac" -o -name "*.mp3" | while read file
        do case "$path" in
          ($MUSIC/*) echo "${file/$MUSIC\/}";;
          (*) mkdir -p "$LINKS" && ln -fs "$file" "$LINKS/$(basename "$file")" && echo "${LINKS#$MUSIC/}/$(basename "$file")";;
        esac done
    fi
  done
else
  test "$1" = "-q" && quiet=-q && shift
  { "$0" -r "$@" && mpc -q update --wait; } |
    xargs --delim='\n' mpc insert
  test $(mpc status | wc -l) -gt 1 && mpc $quiet next || mpc $quiet play
fi
